"""
TWSE 資料下載工具 - 欄位設定
"""
from typing import Dict, List

# =========================
# 欄位保留設定
# =========================
KEEP_COLUMNS: Dict[str, List[str]] = {
    'balance_sheet': [
        # 識別與時間序列 (使用處理後的統一格式)
        '代號',     # 處理後：公司代號 → 代號
        '名稱',     # 處理後：公司名稱 → 名稱
        '年度',     # 處理後：民國年度格式
        '季別',
        # 核心計算 (ROE, 盈再率) - 這些欄位已確認存在於資料中
        '權益總計',  # ROE 分母 (包含母公司業主權益與非控制權益)
        '不動產及設備－淨額',       # 盈再率組件
        '無形資產－淨額',           # 盈再率組件
        # 風險與輔助資訊
        '流動資產',
        '資產總額',
        '流動負債',
        '非流動負債',
        '非控制權益',
        '每股參考淨值',
    ],
    'income_statement': [
        # 識別與時間序列 (使用處理後的統一格式)
        '代號',     # 處理後：公司代號 → 代號
        '名稱',     # 處理後：公司名稱 → 名稱
        '年度',     # 處理後：民國年度格式
        '季別',
        '出表日期',

        # 核心計算 (ROE, 穩定性)
        # 新增計算欄位
        '淨利',  # 由本期淨利（淨損）或淨利（損）歸屬於母公司業主在 Q4 計算得出
        '本期淨利（淨損）',  # 用於 ROE 計算的主要欄位 (GoodInfo 相容)
        '淨利（損）歸屬於母公司業主',
        '營業收入',
        '營業成本',
        # 輔助與相容性
        '稅後淨利',
        '基本每股盈餘（元）',
    ],
    'dividend': [
        # 識別與時間序列 (使用處理後的統一格式)
        '代號',        # 處理後：公司代號名稱 → 代號
        '名稱',        # 處理後：公司代號名稱 → 名稱
        '年度',        # 處理後：民國年度格式
        '季別',        # 處理後：標準化格式
        '現金股利',
        '股東會日期',
        '股利所屬期間',
        '決議（擬議）進度',
        # 核心計算 (現金配發/IRR)
        '股東配發-盈餘分配之現金股利(元/股)',
        '股東配發-法定盈餘公積發放之現金(元/股)',
        '股東配發-資本公積發放之現金(元/股)',
        # '股東配發-股東配發之現金(股利)總金額(元)',
        # 配股相關
        '股東配發-盈餘轉增資配股(元/股)',
        '股東配發-法定盈餘公積轉增資配股(元/股)',
        '股東配發-資本公積轉增資配股(元/股)',
        '股東配發-股東配股總股數(股)'
    ],
    'cash_flow': [
        # 識別與時間序列 (使用處理後的統一格式)
        '代號',     # 處理後：公司代號 → 代號
        '名稱',     # 處理後：公司名稱 → 名稱
        '年度',     # 處理後：民國年度格式
        '季別',
        # 核心計算 (風險驗證)
        '營業活動之淨現金流入（流出）',
    ],
    'etf_dividend': [
        # 識別與時間序列 (使用處理後的統一格式)
        '代號',        # 處理後：證券代號 → 代號
        '名稱',        # 處理後：證券簡稱 → 名稱
        '年度',        # 處理後：民國年度格式
        '季別',        # 處理後：依除息交易日判斷
        # 日期資訊
        '除息交易日',
        '收益分配基準日',
        '收益分配發放日',
        # 收益資訊
        '配息',
        '公告年度'
    ]
}

# =========================
# 數值欄位設定
# =========================
NUMERIC_COLUMNS: Dict[str, List[str]] = {
    'balance_sheet': [
        '權益總計',
        '不動產及設備－淨額',
        '無形資產－淨額',
        '流動資產',
        '資產總額',
        '流動負債',
        '非流動負債',
        '非控制權益',
        '每股參考淨值'
    ],
    'income_statement': [
        '本期淨利（淨損）',
        '淨利（損）歸屬於母公司業主',
        '營業收入',
        '營業成本',
        '稅後淨利',
        '基本每股盈餘（元）'
    ],
    'dividend': [
        '股東配發-盈餘分配之現金股利(元/股)',
        '股東配發-法定盈餘公積發放之現金(元/股)',
        '股東配發-資本公積發放之現金(元/股)',
        '股東配發-股東配發之現金(股利)總金額(元)',
        '股東配發-盈餘轉增資配股(元/股)',
        '股東配發-法定盈餘公積轉增資配股(元/股)',
        '股東配發-資本公積轉增資配股(元/股)',
        '股東配發-股東配股總股數(股)'
    ],
    'cash_flow': [
        '營業活動之淨現金流入（流出）'
    ],
    'etf_dividend': [
        '配息',
        '公告年度'
    ],
    'yingzaibiao': [
        "收盤價",
        "預期報酬率",
        "貴價",
        "淑價",
        "預期ROE",
        "NAV",
        "預期常利",
        "盈再率",
        "預期配息率",
        "股息",
        "股子",
        "ROE1",
        "ROE2",
        "ROE3",
        "ROE4",
        "ROE5",
        "Shares",
        "最近營收年度",
        "營收",
        "近12月最高價",
        "近12月最低價",
        # 盈再表資料 - 數值欄位（待確認後再優化）
    ]
}

# =========================
# 文字欄位設定（需要強制以文字格式儲存的欄位）
# =========================
TEXT_COLUMNS: Dict[str, List[str]] = {
    'yingzaibiao': ['Symbol']  # Symbol 必須以文字格式儲存
}

# =========================
# 欄位重新命名對應
# =========================
COLUMN_RENAME_MAP: Dict[str, Dict[str, str]] = {
    'general': {
        '公司代號': '代號',
        '公司名稱': '名稱',
    },
    'etf_dividend': {
        '證券代號': '代號',
        '證券簡稱': '名稱',
        '收益分配金額 (每1受益權益單位)': '配息',
    }
}

# =========================
# 語意統一欄位設定（如：所有變體都要統一成同一名稱）
# 格式：{報表型態: {標準名稱: [所有變體]}}
# =========================
SEMANTIC_UNIFY_COLUMNS: Dict[str, Dict[str, list]] = {
    'income_statement': {
        '本期淨利（淨損）': [
            '本期淨利（淨損）',
            '本期淨利(淨損)',
            '本期稅後淨利（淨損）',
            '本期稅後淨利(淨損)',
            '本期淨利',
            '本期淨損'
        ],
        '淨利（損）歸屬於母公司業主': [
            '淨利（損）歸屬於母公司業主',
            '淨利（淨損）歸屬於母公司業主',
            '淨利(損)歸屬於母公司業主',
            '淨利(淨損)歸屬於母公司業主',
            '淨利－歸屬於母公司業主',
            '淨利歸屬於母公司業主'
        ]
    },
    'balance_sheet': {
        '資產總額': [
            '資產總額',
            '資產總計'
        ],
        '權益總計': [
            '權益總計',
            '權益總額',
            '權益合計'
        ]
    }
    # 其他報表型態可依需求擴充
}

def get_semantic_unify_columns(report_type: str) -> Dict[str, list]:
    """
    取得指定報表型態的語意統一欄位設定
    """
    return SEMANTIC_UNIFY_COLUMNS.get(report_type, {})

def get_columns_to_keep(report_type: str) -> List[str]:
    """
    取得指定報表類型要保留的欄位清單
    
    Args:
        report_type: 報表類型
        
    Returns:
        欄位名稱清單
        
    Raises:
        KeyError: 不支援的報表類型
    """
    if report_type not in KEEP_COLUMNS:
        raise KeyError(f"不支援的報表類型: {report_type}")
    
    return KEEP_COLUMNS[report_type].copy()

def get_numeric_columns(report_type: str) -> List[str]:
    """
    取得指定報表類型的數值欄位清單
    
    Args:
        report_type: 報表類型
        
    Returns:
        數值欄位名稱清單
    """
    return NUMERIC_COLUMNS.get(report_type, []).copy()

def get_text_columns(report_type: str) -> List[str]:
    """
    取得指定報表類型需要以文字格式儲存的欄位清單
    
    Args:
        report_type: 報表類型
        
    Returns:
        文字欄位名稱清單
    """
    return TEXT_COLUMNS.get(report_type, []).copy()

def get_rename_mapping(report_type: str) -> Dict[str, str]:
    """
    取得指定報表類型的欄位重新命名對應
    
    Args:
        report_type: 報表類型
        
    Returns:
        欄位重新命名對應字典
    """
    # 先取得通用對應
    mapping = COLUMN_RENAME_MAP.get('general', {}).copy()
    
    # 再加上特定報表的對應
    if report_type in COLUMN_RENAME_MAP:
        mapping.update(COLUMN_RENAME_MAP[report_type])
    
    return mapping